# سیستم تعریف کدینگ حسابداری

## نمای کلی

سیستم تعریف کدینگ حسابداری برای شرکت‌های پیمانکاری و ساخت‌وساز طراحی شده است که شامل ساختار سلسله‌مراتبی ۴ سطحه (گروه، کل، معین، تفصیلی) می‌باشد.

## ویژگی‌های اصلی

### ۱. ساختار سلسله‌مراتبی
- **گروه** (۱ رقم): ۱، ۲، ۳، ...
- **کل** (۲ رقم): ۰۱، ۰۲، ۰۳، ...
- **معین** (۳ رقم): ۰۰۱، ۰۰۲، ۰۰۳، ...
- **تفصیلی** (۳ رقم): ۰۰۱، ۰۰۲، ۰۰۳، ...

### ۲. کدینگ پیش‌فرض
سیستم شامل کدینگ پیش‌فرض کامل برای سناریوهای مختلف:

#### گروه ۱ – دارایی‌های جاری
- **کل ۱۰۱ – صندوق**
  - معین ۱۰۱۰۰۱ – صندوق دفتر مرکزی
    - تفصیلی ۱۰۱۰۰۱۰۰۱ – صندوق پروژه A
    - تفصیلی ۱۰۱۰۰۱۰۰۲ – صندوق پروژه B
- **کل ۱۰۲ – بانک**
  - معین ۱۰۲۰۰۱ – بانک ملت
    - تفصیلی ۱۰۲۰۰۱۰۰۱ – بانک ملت حساب جاری پروژه A
- **کل ۱۰۳ – مشتریان / اقساط**
  - معین ۱۰۳۰۰۱ – اقساط خریدار واحد ۱ پروژه A
    - تفصیلی ۱۰۳۰۰۱۰۰۱ – قسط اول

#### گروه ۲ – دارایی‌های غیرجاری
- **کل ۲۰۱ – زمین**
  - معین ۲۰۱۰۰۱ – زمین آورده مالک
    - تفصیلی ۲۰۱۰۰۱۰۰۱ – زمین پروژه A

#### گروه ۳ – بدهی‌ها
- **کل ۳۰۱ – حساب‌های پرداختنی**
  - معین ۳۰۱۰۰۱ – پیمانکاران جزء

#### گروه ۴ – حقوق صاحبان سرمایه
- **کل ۴۰۱ – سرمایه / آورده**
  - معین ۴۰۱۰۰۲ – آورده مالک زمین
  - معین ۴۰۱۰۰۳ – آورده خریداران
  - معین ۴۰۱۰۰۴ – پیش‌پرداخت خریداران

### ۳. سناریوهای پیمانکاری

#### مشارکت نوع اول (مالک زمین، پیمانکار سازنده)
```
آورده مالک زمین → ۴۰۱۰۰۲
هزینه ساخت → ۸۰۱
سهم مالک → ۴۰۳۰۰۱
```

#### مشارکت نوع دوم (زمین فروخته می‌شود)
```
فروش قدرالسهم زمین → ۶۰۱۰۰۱
اقساط خریداران → ۱۰۲۰۰۲
هزینه ساخت → ۸۰۱
سود پیمانکاری → ۷۰۱
```

#### پیش‌فروش واحدها
```
پیش‌پرداخت خریداران → ۴۰۱۰۰۴
اقساط → ۱۰۲۰۰۱
فروش واحدها → ۶۰۲۰۰۱
هزینه ساخت → ۸۰۱
سود → ۴۰۲۰۰۱
```

## نحوه استفاده

### ۱. دسترسی به سیستم
1. وارد بخش حسابداری شوید
2. پروژه مورد نظر را انتخاب کنید
3. روی تب "تعریف کدینگ" کلیک کنید
4. یا مستقیماً به `/accounting/[projectId]/coding` بروید

### ۲. ایمپورت کدینگ پیش‌فرض
1. روی دکمه "ایمپورت کدینگ پیش‌فرض" کلیک کنید
2. در دیالوگ تأیید، "ایمپورت" را انتخاب کنید
3. تمام گروه‌ها و زیرمجموعه‌های آن‌ها اضافه خواهند شد

### ۳. افزودن حساب جدید
#### افزودن گروه:
1. نام گروه جدید را وارد کنید
2. روی دکمه "افزودن" کلیک کنید
3. کد گروه به صورت خودکار پیشنهاد می‌شود

#### افزودن کل:
1. ابتدا گروه را انتخاب کنید
2. نام کل جدید را وارد کنید
3. ماهیت حساب را انتخاب کنید (بدهکار/بستانکار/بدهکار–بستانکار)
4. روی دکمه "افزودن" کلیک کنید

#### افزودن معین:
1. ابتدا کل را انتخاب کنید
2. نام معین جدید را وارد کنید
3. تعیین کنید که آیا دارای تفصیلی است یا خیر
4. روی دکمه "افزودن" کلیک کنید

#### افزودن تفصیلی:
1. ابتدا معینی که دارای تفصیلی است را انتخاب کنید
2. نام تفصیلی جدید را وارد کنید
3. توضیحات اختیاری را وارد کنید
4. روی دکمه "افزودن" کلیک کنید

### ۴. ویرایش و حذف
- آیتم‌های پیش‌فرض قابل حذف نیستند
- آیتم‌های جدید را می‌توان ویرایش یا حذف کرد
- حذف کل/معین، زیرمجموعه‌هایش را نیز حذف می‌کند

## API Endpoints

### گروه‌ها
- `GET /api/accounting/coding/groups?projectId={id}` - دریافت تمام گروه‌ها
- `POST /api/accounting/coding/groups` - افزودن گروه جدید

### کل‌ها
- `GET /api/accounting/coding/classes?projectId={id}&groupId={id}` - دریافت کل‌ها
- `POST /api/accounting/coding/classes` - افزودن کل جدید

### معین‌ها
- `GET /api/accounting/coding/subclasses?projectId={id}&classId={id}` - دریافت معین‌ها
- `POST /api/accounting/coding/subclasses` - افزودن معین جدید

### تفصیلی‌ها
- `GET /api/accounting/coding/details?projectId={id}&subClassId={id}` - دریافت تفصیلی‌ها
- `POST /api/accounting/coding/details` - افزودن تفصیلی جدید

### ایمپورت
- `POST /api/accounting/coding/import-default` - ایمپورت کدینگ پیش‌فرض

## ساختار دیتابیس

### جداول اصلی
- `AccountGroup` - گروه‌های حسابداری
- `AccountClass` - کل‌های حسابداری
- `AccountSubClass` - معین‌های حسابداری
- `AccountDetail` - تفصیلی‌های حسابداری

### فیلدهای مهم
- `code` - کد حساب
- `name` - نام حساب
- `isDefault` - آیا پیش‌فرض است
- `isProtected` - آیا قابل حذف است
- `nature` - ماهیت حساب (فقط برای کل)
- `hasDetails` - آیا دارای تفصیلی است (فقط برای معین)

## اعتبارسنجی

### قوانین کدینگ
1. کد گروه: ۱ رقم (۱-۹)
2. کد کل: ۲ رقم (۰۱-۹۹)
3. کد معین: ۳ رقم (۰۰۱-۹۹۹)
4. کد تفصیلی: ۳ رقم (۰۰۱-۹۹۹)

### قوانین یکتایی
- کد گروه باید در سطح پروژه یکتا باشد
- کد کل باید در سطح گروه یکتا باشد
- کد معین باید در سطح کل یکتا باشد
- کد تفصیلی باید در سطح معین یکتا باشد

## تست سیستم

برای تست سیستم، از اسکریپت تست استفاده کنید:

```bash
npm run test:accounting-coding
```

یا:

```bash
npx tsx scripts/test-accounting-coding.ts
```

## نکات مهم

1. **گروه‌های پیش‌فرض**: همیشه نمایش داده می‌شوند و قابل حذف نیستند
2. **شماره‌گذاری خودکار**: کدهای پیشنهادی بر اساس آخرین کد موجود تولید می‌شوند
3. **سلسله‌مراتب**: حذف والد، فرزندان را نیز حذف می‌کند
4. **ماهیت حساب**: فقط برای کل‌ها تعریف می‌شود
5. **تفصیلی**: فقط برای معین‌هایی که `hasDetails=true` است

## توسعه آینده

- افزودن امکان ویرایش inline
- افزودن جستجو و فیلتر
- افزودن امکان کپی کردن ساختار از پروژه دیگر
- افزودن گزارش‌گیری از کدینگ
- افزودن امکان export/import فایل Excel

