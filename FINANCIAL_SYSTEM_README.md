# سیستم محاسبات مالی

این سیستم برای مدیریت اقساط، پرداخت‌ها و جریمه‌های پروژه‌های ساختمانی طراحی شده است.

## 🏗️ ساختار سیستم

### مدل‌های داده (Database Models)

1. **Unit (واحد)**: هر واحد متعلق به یک کاربر و پروژه
2. **InstallmentDefinition (تعریف قسط)**: تعریف اقساط برای هر پروژه
3. **UserInstallment (قسط کاربر)**: سهم هر کاربر از هر قسط
4. **Payment (پرداخت)**: ثبت پرداخت‌های کاربران
5. **Penalty (جریمه)**: محاسبه جریمه‌های تأخیر

### دسترسی‌ها

#### 👨‍💼 مدیر (Admin)
- مشاهده همه پروژه‌ها و واحدها
- تعریف اقساط پروژه
- تعیین سهم قسط برای هر کاربر
- ثبت و ویرایش پرداخت‌ها
- تعیین نرخ جریمه روزانه
- مشاهده گزارش کلی پروژه

#### 👤 کاربر (User)
- مشاهده پروژه‌ها و واحدهای خود
- مشاهده لیست اقساط مربوط به خود
- مشاهده جزئیات پرداخت‌های خود
- مشاهده جدول جریمه‌های خود
- مشاهده خلاصه وضعیت مالی

## 🚀 راه‌اندازی

### 1. اجرای Migration
```bash
npx prisma migrate dev --name add_financial_models
```

### 2. ایجاد داده‌های نمونه
```bash
npx tsx scripts/seed-financial-data.ts
```

### 3. اجرای پروژه
```bash
npm run dev
```

## 📱 صفحات و کامپوننت‌ها

### صفحات اصلی
- `/finance` - لیست پروژه‌ها با اطلاعات مالی
- `/finance/[projectId]` - جزئیات مالی پروژه

### کامپوننت‌های مالی
- `SummaryCard` - کارت خلاصه اطلاعات مالی
- `InstallmentTable` - جدول اقساط کاربر
- `PaymentTable` - جدول جزئیات پرداخت‌ها
- `PenaltyTable` - جدول جریمه‌ها
- `PaymentChart` - نمودار پیشرفت پرداخت‌ها

## 🔧 API Routes

### پروژه‌ها
- `GET /api/finance/projects` - لیست پروژه‌ها
- `GET /api/finance/projects/[projectId]` - جزئیات مالی پروژه

### اقساط
- `GET /api/finance/installments?projectId=xxx` - لیست اقساط
- `POST /api/finance/installments` - ایجاد قسط جدید (فقط ادمین)

### پرداخت‌ها
- `GET /api/finance/payments?projectId=xxx` - لیست پرداخت‌ها
- `POST /api/finance/payments` - ثبت پرداخت جدید (فقط ادمین)

## 🧮 منطق محاسبات

### محاسبه سهم کاربر
```typescript
userShare = (totalProjectAmount * userUnitArea) / totalProjectArea
```

### وضعیت قسط
- **PAID**: مانده = ۰
- **PARTIAL**: مانده > ۰ و پرداختی > ۰
- **PENDING**: هیچ پرداختی ثبت نشده و هنوز سررسید نرسیده
- **OVERDUE**: هیچ پرداختی ثبت نشده و از سررسید گذشته

### محاسبه جریمه
```typescript
penaltyAmount = remainingAmount * (dailyRate / 100) * daysLate
```

### انتقال مازاد پرداخت
اگر کاربر بیشتر از مبلغ قسط پرداخت کند، مازاد به صورت خودکار به قسط بعدی منتقل می‌شود.

## 📊 ویژگی‌های سیستم

### برای مدیران
- ✅ تعریف اقساط پروژه
- ✅ ثبت پرداخت‌های کاربران
- ✅ محاسبه خودکار جریمه‌ها
- ✅ گزارش‌گیری کامل
- ✅ مدیریت دسترسی‌ها

### برای کاربران
- ✅ مشاهده اقساط شخصی
- ✅ پیگیری پرداخت‌ها
- ✅ مشاهده جریمه‌ها
- ✅ خلاصه وضعیت مالی
- ✅ نمودار پیشرفت

## 🎨 طراحی UI/UX

- استفاده از Material-UI برای طراحی یکپارچه
- پشتیبانی کامل از زبان فارسی
- طراحی ریسپانسیو برای موبایل و دسکتاپ
- رنگ‌بندی مناسب برای وضعیت‌های مختلف
- نمودارهای بصری برای نمایش داده‌ها

## 🔒 امنیت

- احراز هویت کامل برای تمام API ها
- کنترل دسترسی بر اساس نقش کاربر
- اعتبارسنجی ورودی‌ها
- محافظت در برابر SQL Injection

## 📈 آمار و گزارش‌ها

### خلاصه مالی
- جمع کل سهم
- مجموع پرداختی‌ها
- مانده کل
- مجموع جریمه‌ها
- درصد پیشرفت پرداخت

### جزئیات
- لیست کامل اقساط با وضعیت
- تاریخچه پرداخت‌ها
- محاسبه جریمه‌ها
- نمودار پیشرفت

## 🚀 توسعه آینده

- [ ] اعلان‌های خودکار برای سررسید اقساط
- [ ] گزارش‌های PDF
- [ ] پنل مدیریت پیشرفته
- [ ] API برای اپلیکیشن موبایل
- [ ] سیستم اعلان‌های ایمیل
- [ ] پشتیبانی از چندین ارز
- [ ] گزارش‌های تحلیلی پیشرفته

## 🐛 عیب‌یابی

### مشکلات رایج
1. **خطای دسترسی**: بررسی نقش کاربر و مجوزها
2. **محاسبات نادرست**: بررسی داده‌های ورودی و منطق محاسبات
3. **عدم نمایش داده**: بررسی اتصال دیتابیس و API ها

### لاگ‌ها
تمام عملیات مالی در کنسول لاگ می‌شوند. برای عیب‌یابی، کنسول مرورگر و سرور را بررسی کنید.

## 📞 پشتیبانی

برای گزارش باگ یا درخواست ویژگی جدید، لطفاً با تیم توسعه تماس بگیرید.
